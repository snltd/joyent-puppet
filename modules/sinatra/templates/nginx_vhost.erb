server {
  root        <%= File.join(@params['dir'], 'public') %>;
<%- if @params.include?('default') %>
  server_name _;
  listen      80 default_server;
<%- else %>
  server_name <%= @params['server_name'] %>;
  listen      80;
<%- end %>
  access_log  <%= File.join('/var/log/nginx', "#{@site}.access.log") %> vhost;
  error_log   <%= File.join('/var/log/nginx', "#{@site}.error.log") %>;

  location / {
    try_files $uri /cache$uri/ @sinatra;

    if ($http_user_agent = 'Site24x7') {
      access_log off;
      return 200;
    }
  }

  location @sinatra {

    proxy_pass            http://localhost:<%= @params['port'] %>;
    proxy_read_timeout    90;
    proxy_connect_timeout 90;
    proxy_redirect        off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP $remote_addr;
    proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;

    #proxy_ignore_headers X-Accel-Expires Expires Cache-Control Set-Cookie;
    #proxy_cache_valid 200 302 60h;
    #proxy_cache           cz;
    #proxy_cache_key       $uri;
    #proxy_read_timeout    90;
    #proxy_connect_timeout 90;
    #proxy_redirect        off;
    #proxy_set_header      Host $host;
    #proxy_set_header      X-Real-IP $remote_addr;
    #proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}
